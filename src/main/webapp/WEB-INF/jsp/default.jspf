<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<table class="table table-bordered">
 <thead>
    <tr>
      <th collspan="3">${report.label}</th>
    </tr>
  </thead>
        <tr style="background-color: #F5F5F5" id="template" class="hidden">
          <td class="mainRow" width="50%" rowspan="1"><p><span class="mainLabel label">LABEL-0</span></p>
           <span class="title">Title</span><br />
           <i><small style="font-size: 10pt;" class="comment">- descriptionline</small></i>
          </td>
          
          <td width="30%" class="groupLabelText">Î£</td>
          <td width="20%" >
             <div class="progress progress-striped">
               <div class="bar mainPercentage" style="width: 100%;"></div>
             </div>
          </td>
          <td nowrap="nowrap"><small class="mainDuration"></small></td>
        </tr>
      
        <tr id="subTemplate" class="hidden">
        <td class="subLabel"></td>
        <td><div class="progress-gray progress progress-striped progress-inverse">
  <div class="bar subPercentage" style="width:0%"></div>
</div></td><td nowrap="nowrap"><small class="subDuration"></small></td>
        </tr>
        <!-- /c:forEach>  -->

</table>
<script src="/assets/bootstrap/js/bootstrap.js"></script>

    <script type='text/javascript'>
    
      if (!window.WebSocket)
        alert("WebSockets are not supported by this browser");
      
      var reports = {
    		  connect: function(name) {
          this.name = name;
          var location = document.location.toString().replace('http://','ws://').replace('https://','wss://');
          this.ws = new WebSocket("ws://${srvSocket}/ws/");
          this.ws.onopen = this.onOpen;
          this.ws.onmessage = this.onMessage;
          this.ws.onerror = this.onError;
          this.ws.onclose = this.onClose;
        },
        
        onOpen: function(){
          $('#info').text('c');
        },
        
        onError: function(){
            $('#info').text('error');
          },
        
        send: function(message){
          if (this.ws)
            this.ws.send(message);
        },
        
        onMessage: function(m) {
          if (m.data){
        	  $('.table tr.copy').each(function() {
        		  $(this).remove();
        	  } );
        	  
        	  $.each($.parseJSON(m.data), function(i, field) {
           		  var main = $('#template').clone().attr('id', field.htmlid).addClass("copy");
           		  $(".mainLabel", main).text(field.id);
           		  $(".groupLabelText", main).text(field.path);
           		  $(".title", main).text(field.title);
           		  $(".comment", main).text(field.comment);
           		  $(".mainDuration", main).text(field.duration);
           		  $(".mainPercentage", main).css('width', field.durationPercentage + '%');
           	  	var subLabel = $(field.sub);
           	 
           		  main.removeClass("hidden");
           		  main.appendTo('.table');
           			if (subLabel.length > 1) {
           		  $(".mainRow", main).attr("rowspan", subLabel.length + 1);
           		  $.each(subLabel, function(i, field) {
           			
              		var sub = $('#subTemplate').clone().attr('id',  field.htmlid).addClass("copy");
              		$(".subDuration", sub).text(field.duration);
              		$(".subPercentage", sub).css('width', field.durationPercentage + '%');
              		$(".subLabel", sub).text(field.path);
              		sub.removeClass("hidden");
              		sub.appendTo('.table');
           			});
           			} else {
           				$(".mainRow", main).attr("rowspan", 1);
           			}
        
        	  });
        	  var ids = new Array;
        	  i=0;
        	  $('.table tr.copy').each(function() {
        		  ids[i++] = $(this).attr('id');
        	  });
        	  this.send(ids);
          }
        },
        
        onClose: function(m) {
          this.ws = null;
          $('#info').text('off');
        }
        
      };
      reports.connect("${reportID}");
      
    </script>